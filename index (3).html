<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf--8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GIRLS IN HANOI — Project</title>
    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      crossorigin=""
    ></script>
    <!-- MarkerCluster -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  </head>
  <body>
    <!-- Header -->
    <header>
      <div class="wrap brand">
        <div class="brand-title">
          <div class="dot"></div>
          <div>
            <h1>Girls in Hanoi</h1>
            <div class="sub">project space • mapping • reading • images</div>
          </div>
        </div>
        <nav class="header-nav" id="main-nav">
          <a href="index.html">HOME</a>
          <a href="film.html">FILM</a>
          <a href="philosophy.html">PHILOSOPHY</a>
          <a href="about.html">ABOUT ME</a>
        </nav>
      </div>
    </header>

    <!-- Hero / Landing -->
    <section class="hero" id="home">
      <img
        class="bg"
        alt="Hanoi Urban"
        src="./photos/hanoi.jpg"
      />
      <div class="veil"></div>
      <div class="center">
        <h1 class="title">GIRLS IN HANOI</h1>
        <p class="strap">
          Historical representations of women in Hà Nội — from heroines and
          street names to present‑day safety, visibility, and everyday
          belonging. This living page brings together a community safety map,
          curated readings on the city and women, and a visual shelf of
          photography & short films.
        </p>
        <div class="cta">
          <button
            class="btn pink"
            onclick="document.getElementById('map').scrollIntoView()"
          >
            Open Safety Map ↓
          </button>
        </div>
      </div>
      <div class="ticker">
        <div class="inner" id="tickerInner">
          <span>✦ safety</span><span>belonging</span><span>sisterhood</span
          ><span>street memory</span><span>lighting</span
          ><span>everyday routes</span><span>public space</span
          ><span>feminist urbanism</span>
        </div>
      </div>
    </section>

    <!-- Safety Map -->
    <main class="wrap" style="padding: 16px 16px 40px">
      <section id="map" class="card">
        <h2 style="margin: 6px 0">Hanoi Girls Safety-Map</h2>
        <p class="muted" style="margin: 0 0 10px">
          Community‑reported points. Click anywhere on the map to add a new pin.
        </p>
        <div id="mapCanvas"></div>
        <div class="legend">
          <span class="pill"
            ><span class="dot" style="background: var(--pink)"></span>
            Harassment</span
          >
          <span class="pill"
            ><span class="dot" style="background: #ffb85c"></span>
            Catcalling</span
          >
          <span class="pill"
            ><span class="dot" style="background: #5eead4"></span>
            Stalking</span
          >
          <span class="pill"
            ><span class="dot" style="background: var(--red)"></span>
            Robbery</span
          >
          <span class="pill"
            ><span class="dot" style="background: var(--lav)"></span> Poor
            lighting</span
          >
          <span class="pill"
            ><span class="dot" style="background: var(--slate)"></span>
            Isolated</span
          >
          <span class="pill"
            ><span class="dot" style="background: var(--mint)"></span> Safe
            haven</span
          >
        </div>
        <div class="muted" style="margin-top: 8px">
          Showing <b id="countVis">0</b> reports. In emergencies call
          <b>111</b> (children) or <b>113</b> (police).
        </div>
      </section>
    </main>

    <script>
      // ===== Ticker animation =====
      const ticker = document.getElementById("tickerInner");
      let tx = 0;
      function run() {
        tx = (tx + 0.6) % 10000;
        ticker.style.transform = `translateX(${-tx}px)`;
        requestAnimationFrame(run);
      }
      run();

      // ===== Safety Map core =====
      const STORE_KEY = "hn_girls_safety_pink_v2";
      const $ = (id) => document.getElementById(id);
      const colors = {
        harassment: "#ff7abf",
        catcalling: "#ffb85c",
        stalking: "#5eead4",
        robbery: "#ff6b6b",
        poor_lighting: "#c4b5fd",
        isolated: "#94a3b8",
        safe_haven: "#9df0dc",
      };

      function seedData() {
        return [
          // Hoàn Kiếm
          R(
            "harassment",
            "high",
            "evening",
            21.0285,
            105.8542,
            "Hoàn Kiếm",
            "Verbal harassment while walking; crowded with tourists."
          ),
          R(
            "catcalling",
            "medium",
            "late_night",
            21.0302,
            105.8521,
            "Hoàn Kiếm",
            "Catcalling by 2–3 people; shops still open."
          ),
          R(
            "poor_lighting",
            "medium",
            "late_night",
            21.0346,
            105.8483,
            "Hoàn Kiếm",
            "Alley lacks lighting; many parked motorbikes."
          ),
          R(
            "safe_haven",
            "low",
            "late_night",
            21.0289,
            105.8531,
            "Hoàn Kiếm",
            "Friendly 24/7 convenience store; guard helped."
          ),
          // Tây Hồ
          R(
            "stalking",
            "medium",
            "evening",
            21.069,
            105.8267,
            "Tây Hồ",
            "Light stalking when jogging by the lake; avoid emptier stretch."
          ),
          R(
            "isolated",
            "medium",
            "late_night",
            21.0705,
            105.8202,
            "Tây Hồ",
            "Sparse houses, fewer cameras."
          ),
          R(
            "safe_haven",
            "low",
            "evening",
            21.0718,
            105.8304,
            "Tây Hồ",
            "Cafe open late; staff supportive."
          ),
          // Cầu Giấy
          R(
            "robbery",
            "high",
            "evening",
            21.0368,
            105.7902,
            "Cầu Giấy",
            "Phone snatched crossing busy street."
          ),
          R(
            "harassment",
            "medium",
            "afternoon",
            21.0379,
            105.7929,
            "Cầu Giấy",
            "Teasing near bus stop; many bystanders."
          ),
          R(
            "poor_lighting",
            "low",
            "evening",
            21.0401,
            105.7845,
            "Cầu Giấy",
            "Several park lights broken — go in groups."
          ),
        ];
      }

      function loadData() {
        const raw = localStorage.getItem(STORE_KEY);
        if (raw) {
          try {
            return JSON.parse(raw);
          } catch (e) {
            console.warn(e);
          }
        }
        const seed = seedData();
        localStorage.setItem(STORE_KEY, JSON.stringify(seed));
        return seed;
      }

      function saveData(list) {
        localStorage.setItem(STORE_KEY, JSON.stringify(list));
      }
      function R(type, severity, timeOfDay, lat, lng, district, notes) {
        return {
          id: "d_" + Math.random().toString(36).slice(2, 9),
          type,
          severity,
          timeOfDay,
          lat,
          lng,
          district,
          notes,
          status: "demo",
          createdAt: new Date().toISOString(),
        };
      }

      let data = loadData();

      // Init map
      let map, cluster;
      function initMap() {
        if (map) return;
        map = L.map("mapCanvas").setView([21.0285, 105.8542], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap",
        }).addTo(map);
        cluster = L.markerClusterGroup({
          showCoverageOnHover: false,
          spiderfyOnEveryZoom: true,
          iconCreateFunction: function (cluster) {
            const count = cluster.getChildCount();
            return L.divIcon({
              html: `<div style="background:linear-gradient(135deg,var(--pink),var(--pink-2));color:#120b12;border:2px solid #fff2;border-radius:999px;padding:6px 10px;font-weight:800">${count}</div>`,
              className: "cluster",
              iconSize: [40, 40],
            });
          },
        });
        map.addLayer(cluster);
        render(data);
        map.on("click", onMapClick);
      }
      initMap();

      let newPinState = {
        lat: null,
        lng: null,
        issue: null,
        severity: null,
        timeOfDay: null,
      };

      function selectIssue(el, issue) {
        newPinState.issue = issue;
        document.querySelectorAll("#issue-choices button").forEach((btn) => {
          btn.style.backgroundColor = "";
          btn.style.color = "";
        });
        el.style.backgroundColor = "var(--pink)";
        el.style.color = "#fff";
        checkIfReady();
      }

      function selectSeverity(el, severity) {
        newPinState.severity = severity;
        document.querySelectorAll("#severity-choices button").forEach((btn) => {
          btn.style.backgroundColor = "";
          btn.style.color = "";
        });
        el.style.backgroundColor = "var(--pink)";
        el.style.color = "#fff";
        checkIfReady();
      }

      function selectTime(el, time) {
        newPinState.timeOfDay = time;
        document.querySelectorAll("#time-choices button").forEach((btn) => {
          btn.style.backgroundColor = "";
          btn.style.color = "";
        });
        el.style.backgroundColor = "var(--pink)";
        el.style.color = "#fff";
        checkIfReady();
      }

      function checkIfReady() {
        const confirmBtn = document.getElementById("confirmPinBtn");
        if (
          newPinState.issue &&
          newPinState.severity &&
          newPinState.timeOfDay &&
          confirmBtn
        ) {
          confirmBtn.disabled = false;
        }
      }

      function onMapClick(e) {
        newPinState = {
          lat: e.latlng.lat,
          lng: e.latlng.lng,
          issue: null,
          severity: null,
          timeOfDay: null,
        };

        const popupContent = `
        <div>
          <h4 style="margin:0 0 8px">Describe this location</h4>
          <h5 style="margin:0 0 8px">1. Select issue type</h5>
          <div class="popup-choices" id="issue-choices">
            <button onclick="selectIssue(this, 'harassment')">Harassment</button>
            <button onclick="selectIssue(this, 'catcalling')">Catcalling</button>
            <button onclick="selectIssue(this, 'stalking')">Stalking</button>
            <button onclick="selectIssue(this, 'robbery')">Robbery</button>
            <button onclick="selectIssue(this, 'poor_lighting')">Poor lighting</button>
            <button onclick="selectIssue(this, 'isolated')">Isolated</button>
            <button onclick="selectIssue(this, 'safe_haven')">Safe Haven</button>
          </div>
        </div>
        <div>
          <h5 style="margin:8px 0 8px">2. Select severity</h5>
          <div class="popup-choices" id="severity-choices">
            <button onclick="selectSeverity(this, 'low')">Low</button>
            <button onclick="selectSeverity(this, 'medium')">Medium</button>
            <button onclick="selectSeverity(this, 'high')">High</button>
          </div>
        </div>
        <div>
          <h5 style="margin:8px 0 8px">3. Select time</h5>
          <div class="popup-choices" id="time-choices">
            <button onclick="selectTime(this, 'morning')">Morning</button>
            <button onclick="selectTime(this, 'afternoon')">Afternoon</button>
            <button onclick="selectTime(this, 'evening')">Evening</button>
            <button onclick="selectTime(this, 'late_night')">Late Night</button>
          </div>
        </div>
        <div style="margin-top: 16px;">
            <button id="confirmPinBtn" onclick="addPin()" disabled style="width: 100%; background: var(--pink); color: white; padding: 8px; border: none; border-radius: 4px; cursor: pointer;">Add Pin</button>
            <div class="muted" style="font-size:11px; margin-top:8px; text-align:center;">Select an issue, severity, and time to add a pin.</div>
        </div>
      `;

        L.popup({ minWidth: 280 })
          .setLatLng(e.latlng)
          .setContent(popupContent)
          .openOn(map);
      }

      function addPin() {
        if (
          !newPinState.lat ||
          !newPinState.issue ||
          !newPinState.severity ||
          !newPinState.timeOfDay // Fixed: Check for timeOfDay before adding
        ) {
          return; // Don't add if data is incomplete
        }
        const point = {
          id: "u_" + Date.now().toString(36),
          type: newPinState.issue,
          severity: newPinState.severity,
          timeOfDay: newPinState.timeOfDay, // Fixed: Use selected time
          lat: newPinState.lat,
          lng: newPinState.lng,
          notes: "User reported via map click.",
          status: "user",
          createdAt: new Date().toISOString(),
        };

        data.push(point);
        saveData(data);
        cluster.addLayer(marker(point));
        map.closePopup();
        $("countVis").textContent = cluster.getLayers().length;
      }

      function marker(point) {
        const color = colors[point.type] || "#ffd6e7";
        const icon = L.divIcon({
          className: "marker",
          html: `<div style="transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;border:2px solid #120b12;background:${color};box-shadow:0 0 0 3px #0004"></div>`,
        });
        const m = L.marker([point.lat, point.lng], { icon });
        m.bindPopup(popupHTML(point));
        return m;
      }

      function popupHTML(p) {
        const t =
          {
            harassment: "Harassment",
            catcalling: "Catcalling",
            stalking: "Stalking",
            robbery: "Robbery",
            poor_lighting: "Poor lighting",
            isolated: "Isolated",
            safe_haven: "Safe haven",
          }[p.type] || p.type;
        const sev =
          { low: "Low", medium: "Medium", high: "High" }[p.severity] ||
          p.severity;
        const tod =
          {
            morning: "Morning",
            afternoon: "Afternoon",
            evening: "Evening",
            late_night: "Late Night",
          }[p.timeOfDay] || p.timeOfDay;
        return `<b style="color:${
          colors[p.type]
        }">${t}</b> • Severity <b>${sev}</b><br/>Time: <b>${tod}</b> ${
          p.district ? "• " + p.district : ""
        }<br/>${
          p.notes ? '"' + escapeHTML(p.notes) + '"' : ""
        }<div class="muted" style="margin-top:6px">ID: ${p.id} • ${
          p.status === "demo" ? "demo" : "user"
        } • ${new Date(p.createdAt).toLocaleString()}</div>`;
      }

      function escapeHTML(s) {
        return s.replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      function render(list) {
        if (!cluster) return;
        cluster.clearLayers();
        list.forEach((p) => cluster.addLayer(marker(p)));
        $("countVis").textContent = list.length;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const currentPage = window.location.pathname.split("/").pop();
        const navLinks = document.querySelectorAll("#main-nav a");

        navLinks.forEach((link) => {
          const linkPage = link.getAttribute("href");
          if (linkPage === currentPage) {
            link.classList.add("active");
          }
        });
      });
    </script>
  </body>
</html>